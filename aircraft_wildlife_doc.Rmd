---
title: "Aircraft Wildlife collisions"
author: "Alexander Flick & Vy Nguyen"
date: "21/07/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data preparation

```{r echo=FALSE, fig.asp=1}

library(openintro)
data("birds")
library(ggplot2)
library(patchwork)
library(ggmosaic)

theme_set(theme_classic())
color_pal<-c("seagreen", "steelblue", "darkred", "orange")
theme.title<-theme(
    plot.title = element_text(
      hjust = 0.5, # center
      size = 12,
      color = "steelblue",
      face = "bold"
    ),
    plot.subtitle = element_text(
      hjust = 0.5, # center
      size = 10,
      color = "gray",
      face = "italic"
    )
  )

factor_phase_flt<-c("Parked", "Taxi", "Take-off run", "Climb", "En Route", "Descent", "Approach", "Landing Roll")
birds$phase_of_flt<-factor(birds$phase_of_flt, levels=factor_phase_flt)

factor_struck<-c("0", "1", "2-10", "11-100", "Over 100")
birds$birds_struck<-factor(birds$birds_struck, levels=factor_struck)

birds$num_engs <- as.factor(birds$num_engs)

#\newpage
```

## Handling missing values

```{r echo=FALSE, message=FALSE}
#get rows where birds struck is missing
df <- birds[is.na(birds$birds_struck), c("remarks", "birds_seen", "effect", "birds_struck")]
no_strike <- grepl("NOT A STRIKE|NO STRIKE|NOT A STRKE", df$remarks)
# set birds_struck to 0 for "no strike"
birds[is.na(birds$birds_struck),][no_strike,"birds_struck"] <- "0"

# Amount of na for each column
missing <- sapply(birds, function(x) sum(is.na(x)))

barplot(missing)
```

# Analysis of strikes

```{r echo=FALSE, fig.asp=1}

above_ground <- birds[as.integer(birds$phase_of_flt)>3 & as.integer(birds$phase_of_flt)<8 & !is.na(birds$phase_of_flt),]
height_by_phase <- ggplot(above_ground) +
  aes(x = phase_of_flt, y = height, fill=phase_of_flt) +
  stat_boxplot(geom="errorbar", width=0.4) +
  geom_boxplot()
# Heights during Descent are on average higher than 
# hypothesis: Collisions happen more often during Descent and are therefore more prominent in the data set?
count_phase <- ggplot(above_ground) +
  aes(x = phase_of_flt, fill=phase_of_flt) +
  geom_bar()

height_by_phase / count_phase
## descent and en-route are about equal 

```

## Closer look on En Rout and Descent
```{r echo=TRUE, fig.asp=1}
#plot height density for Descent and EnRoute
ggplot(birds[birds$phase_of_flt== "Descent" | birds$phase_of_flt=="En Route",]) +
  aes(x = height, group=phase_of_flt,fill=phase_of_flt ) +
  geom_density(adjust=1.5,alpha=.8)

#Two sample t.test for height dependent on phase of flight ("Descent" and "En Route")
t.test(height~phase_of_flt, data = birds[as.integer(birds$phase_of_flt)>4 & as.integer(birds$phase_of_flt)<7 & !is.na(birds$phase_of_flt),])

```

check if clouds have an influence on effect 
hyptohesis: clouds lead to less vision therefore the pilot might not see the birds

```{r echo=FALSE, fig.asp=1}
birds.filtered<-birds[!is.na(birds$effect) & !is.na(birds$sky),]
birds.filtered$effectYes<-as.factor(birds.filtered$effect != "None")

prop.table(table(birds.filtered$sky,birds.filtered$effectYes),1)
mosaicplot(prop.table(table(birds.filtered$sky,birds.filtered$effectYes),1))

prop.table(table(birds.filtered$sky,birds.filtered$birds_struck),1)

```

results show, that clouds do not have an impact on effect variable, 
the proportion of effect=true is actually a little higher for some clouds and overcast

## Analysis of effect variable

```{r echo=FALSE, fig.asp=1}
ggplot(birds.filtered[!is.na(birds.filtered$birds_struck),]) +
  aes(x = birds_struck, fill = effectYes) +
  geom_bar(position="fill")

#comparison right? because we actually want to compare here the positive impact
ggplot(birds.filtered) +
  aes(x = birds_struck, fill = effect) +
  geom_bar(position="fill")

#mosaic in ggplot2
#https://xang1234.github.io/mosaicdiagrams/

#mosaic plot better than barplot visualizes also absolute differences
ggplot(birds.filtered[!is.na(birds.filtered$ac_mass),]) +
  geom_mosaic(aes(x = product(ac_mass), fill=effectYes))

# Most collisions during the day #genauer betrachten
ggplot(birds) + 
  aes(x=time_of_day, fill=birds_struck) + 
  geom_bar()

```

dp<-ggplot(iris) +
   aes(x=Petal.Width, color=Species, fill=Species) +
   geom_density(alpha=0.25) + 
   theme(legend.position = "none") +
   scale_color_manual(values = color_pal) + 
   scale_fill_manual(values = color_pal)

bp<-ggplot(iris) +
  aes(x=Petal.Width, y=Species, fill=Species, color=Species) +
  stat_boxplot(geom="errorbar",width=0.2) +
  geom_boxplot(varwidth = TRUE, alpha=0.2) + 
  geom_jitter(alpha = 0.25, width = 0.2) +
  theme(legend.position = "none") +
  scale_color_manual(values = color_pal) + 
  scale_fill_manual(values = color_pal)

h<-ggplot(iris) +
  aes(x=Petal.Width, color=Species, fill=Species) +
  geom_histogram(bins=30, alpha=0.25) + 
  scale_color_manual(values = color_pal) + 
  scale_fill_manual(values = color_pal)

dpl<-ggplot(iris) +
   aes(x=Petal.Length, color=Species, fill=Species) +
   geom_density(alpha=0.25) + 
   theme(legend.position = "none") +
   scale_color_manual(values = color_pal) + 
   scale_fill_manual(values = color_pal)

bpl<-ggplot(iris) +
  aes(y=Petal.Length, x=Species, fill=Species, color=Species) +
  stat_boxplot(geom="errorbar",width=0.2) +
  geom_boxplot(varwidth = TRUE, alpha=0.2) + 
  theme(legend.position = "none") +
  scale_color_manual(values = color_pal) + 
  scale_fill_manual(values = color_pal)

sp<-ggplot(iris) +
  aes(x = Petal.Length, y = Petal.Width, shape = Species, color=Species, fill=Species) +
  geom_point() +
  facet_wrap(~Species) +
  scale_color_manual(values = color_pal) + 
  scale_fill_manual(values = color_pal) + 
  labs(
    title = "Petal Width and Length of 150 flowers of Iris",
    subtitle = "In relation to their species",
    x = "Petal Length in cm",
    y = "Petal Width in cm"
  ) + theme.title

dps<-ggplot(iris) +
   aes(x=Sepal.Length, color=Species, fill=Species) +
   geom_density(alpha=0.25) + 
   theme(legend.position = "none") +
   scale_color_manual(values = color_pal) + 
   scale_fill_manual(values = color_pal)

hs<-ggplot(iris) +
  aes(x=Sepal.Length, color=Species, fill=Species) +
  geom_histogram(bins=30, alpha=0.25) + 
  scale_color_manual(values = color_pal) + 
  scale_fill_manual(values = color_pal)

bps<-ggplot(iris) +
  aes(x=Sepal.Length, y=Species, fill=Species, color=Species) +
  stat_boxplot(geom="errorbar",width=0.2) +
  geom_boxplot(varwidth = TRUE, alpha=0.2) + 
  geom_jitter(alpha = 0.25, width = 0.2) +
  theme(legend.position = "none") +
  scale_color_manual(values = color_pal) + 
  scale_fill_manual(values = color_pal)

sps<-ggplot(iris) +
  aes(x = Sepal.Width, y = Sepal.Length, shape = Species, color=Species, fill=Species) +
  geom_point() +
  facet_wrap(~Species) +
  scale_color_manual(values = color_pal) + 
  scale_fill_manual(values = color_pal) + 
  labs(
    title = "Sepal Width and Length of 150 flowers of Iris",
    subtitle = "In relation to their species",
    x = "Sepal Width in cm",
    y = "Sepal Length in cm"
  ) + theme.title

(dp + h) / bp / (dpl + bpl) / sp
sps/ (dps + hs) / bps


### PCA for Iris data  

To do a Principal Component Analysis we will use *prcomp()* and plot the eigenvalues in a scree plot. We see that there's an elbow at 2, so we choose 2 dimensions. *iris.pca$x* has the same dimensions as *X*.  

```{r }
X<-iris[,1:4]             ## exclude the Species column
S <- cov(X)               ## compute variance-covariance matrix 
iris.pca <- prcomp(X)     ## perform PCA
lambda <- eigen(S)$values ## calculate eigenvalues
```

```{r echo=FALSE}
## scree plot
plot(lambda/sum(lambda),                        ## or instead of lambda: iris.pca$sdev^2
    main = "Scree plot of eigenvalues in %",
    col=c("black", "red", "black", "black"))
lines(lambda/sum(lambda))                       ## or: iris.pca$sdev^2
```  

---
title: "Aircraft Wildlife collisions"
author: "Alexander Flick & Vy Nguyen"
date: "21/07/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data preparation

```{r echo=FALSE, fig.asp=1}

library(openintro)
data("birds")
library(ggplot2)
library(patchwork)
library(ggmosaic)

theme_set(theme_classic())
color_pal<-c("seagreen", "steelblue", "darkred", "orange")
theme.title<-theme(
    plot.title = element_text(
      hjust = 0.5, # center
      size = 12,
      color = "steelblue",
      face = "bold"
    ),
    plot.subtitle = element_text(
      hjust = 0.5, # center
      size = 10,
      color = "gray",
      face = "italic"
    )
  )

factor_phase_flt<-c("Parked", "Taxi", "Take-off run", "Climb", "En Route", "Descent", "Approach", "Landing Roll")
birds$phase_of_flt<-factor(birds$phase_of_flt, levels=factor_phase_flt)

factor_struck<-c("0", "1", "2-10", "11-100", "Over 100")
birds$birds_struck<-factor(birds$birds_struck, levels=factor_struck)

birds$num_engs <- as.factor(birds$num_engs)

#birds seen: remove one wrong entry
which(birds$birds_seen==":-10")
birds$birds_seen[9412] <- NA

factor_seen<-c("2-10", "11-100")
birds$birds_seen <- factor(birds$birds_seen, levels=factor_seen) 
  # drop unused level ":-10" by assigning levels again
levels(birds$birds_seen)

#\newpage
```

## Handling missing values

```{r echo=FALSE, message=FALSE}
#get rows where birds struck is missing
df <- birds[is.na(birds$birds_struck), 
            c("remarks", "birds_seen", "effect", "birds_struck")]
no_strike <- grepl("NOT A STRIKE|NO STRIKE|NOT A STRKE", df$remarks)
# set birds_struck to 0 for "no strike"
birds[is.na(birds$birds_struck),][no_strike,"birds_struck"] <- "0"

#TODO: get ac mass and num_engs from aircraft model

sum(is.na(birds$atype)) #0
birds[,c("atype", "num_engs", "ac_mass")]
sapply(birds[,c("atype", "num_engs", "ac_mass")], function(x) sum(is.na(x)))

# Amount of na for each column
missing <- sapply(birds, function(x) sum(is.na(x)))
missing_df <- data.frame("column" = names(missing), 
                         "count" = missing, row.names = NULL)
names(missing_df)[2] <- "count"

ggplot(missing_df) + 
  aes(x=reorder(column, -count), y=count) +
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```

# Analysis of strikes (birds_struck)

```{r echo=FALSE, fig.asp=1}

above_ground <- birds[as.integer(birds$phase_of_flt)>3 & as.integer(birds$phase_of_flt)<8 & !is.na(birds$phase_of_flt),]
height_by_phase <- ggplot(above_ground) +
  aes(x = phase_of_flt, y = height, fill=phase_of_flt) +
  stat_boxplot(geom="errorbar", width=0.4) +
  geom_boxplot()
# Heights during Descent are on average higher than 
# hypothesis: Collisions happen more often during Descent and are therefore more prominent in the data set?
count_phase <- ggplot(above_ground) +
  aes(x = phase_of_flt, fill=phase_of_flt) +
  geom_bar()

height_by_phase / count_phase
## descent and en-route are about equal 

which(birds$height==max(birds$height, na.rm = T))
birds[15053,] # >30000 foot (1 meter = 3,28084 foot)
?birds
```

## Closer look on En Rout and Descent
```{r echo=TRUE, fig.asp=0.5}
#plot height density for Descent and EnRoute
ggplot(birds[birds$phase_of_flt== "Descent" | birds$phase_of_flt=="En Route",]) +
  aes(x = height, group=phase_of_flt,fill=phase_of_flt ) +
  geom_density(adjust=1.5,alpha=.8)

```

t.test
```{r echo=TRUE, fig.asp=1}
#Two sample t.test for height dependent on phase of flight ("Descent" and "En Route")
t.test(height~phase_of_flt, data = birds[as.integer(birds$phase_of_flt)>4 & as.integer(birds$phase_of_flt)<7 & !is.na(birds$phase_of_flt),])

```



```{r echo=FALSE, fig.asp=0.5}
#relationship of amount of birds struck with clouds?
birds$effectYes<- as.factor(birds$effect != "None")
birds.filtered<-birds[!is.na(birds$effect) & !is.na(birds$sky),]

prop.table(table(birds.filtered$sky,birds.filtered$birds_struck),1)
ggplot(birds.filtered)+
  aes(x=birds_struck, fill=sky)+
  geom_bar(position = "fill")
```
For 0 birs struck we have highest percentage of no clouds, so clouds might have an affect on avoiding striking birds. Its about 20% higher compared to 1 bird struck.
for birdsstruck by sky we can see that with increasing amount of birds the sky tends to be more more overcast, as no clouds and some clouds decreases

#Clouds with birds seen

there are only 2 levels in the data available for birds seen

```{r echo=FALSE, fig.asp=0.5}
#relationship of amount of birds seen with clouds?
table(birds$birds_seen)

prop.table(table(birds.filtered$sky,birds.filtered$birds_seen),1)
ggplot(birds.filtered[!is.na(birds.filtered$birds_seen),])+
  aes(x=birds_seen, fill=sky)+
  geom_bar(position = "fill")
```

the proportion of some clouds is nearly the same, but pilots do more often see bigger groups of birds (11-100) when its overcast compared to small groups

```{r echo=FALSE, fig.asp=0.5}
#relationship of amount of birds seen with daytime?
table(birds$birds_seen)

prop.table(table(birds.filtered$time_of_day,birds.filtered$birds_seen),1)
ggplot(birds.filtered[!is.na(birds.filtered$birds_seen) & !is.na(birds.filtered$time_of_day),])+
  aes(x=birds_seen, fill=time_of_day)+
  geom_bar(position = "fill")
```
check speed

```{r echo=FALSE, fig.asp=0.5}
# does speed has an influence on seen? the faster the less likely to see ?
spineplot(birds$speed, as.factor(is.na(birds$birds_seen)))
```
The higher the speed, the less likely to see a bird

### Birds struck out of birds seen

```{r echo=FALSE, fig.asp=0.5}
#Create new column
#calculate only when seen is not na
df <- birds[!is.na(birds$birds_seen) & !is.na(birds$birds_struck),]
table(birds$birds_seen, birds$birds_struck)

df$birds_struck <- factor(df$birds_struck) 

#mosaic plot better than barplot visualizes also absolute differences
ggplot(df) +
  geom_mosaic(aes(x = product( birds_struck,birds_seen ), fill=birds_struck))
```

```{r echo=FALSE, fig.asp=0.5}
#Create new column
#calculate only when seen is not na
df <- birds[!is.na(birds$birds_seen) & !is.na(birds$birds_struck),]
table(birds$birds_seen, birds$birds_struck)

df$birds_struck <- factor(df$birds_struck) 

levels(df$birds_seen)
levels(df$birds_struck)
df$difference_seen_strike <- as.integer(df$birds_struck) < as.integer(df$birds_seen)+2
table(df$difference_seen_strike)

barplot(prop.table(table(df$difference_seen_strike,df$effectYes),2))

ggplot(df) +
  aes(x=difference_seen_strike, fill=effectYes) +
  geom_bar()
```


## Analysis of effect variable

```{r echo=FALSE, fig.asp=0.5}
ggplot(birds.filtered[!is.na(birds.filtered$birds_struck),]) +
  aes(x = birds_struck, fill = effectYes) +
  geom_bar(position="fill")

#comparison right? because we actually want to compare here the positive impact
ggplot(birds.filtered) +
  aes(x = birds_struck, fill = effect) +
  geom_bar(position="fill")

#mosaic in ggplot2
#https://xang1234.github.io/mosaicdiagrams/

#mosaic plot better than barplot visualizes also absolute differences
ggplot(birds.filtered[!is.na(birds.filtered$ac_mass),]) +
  geom_mosaic(aes(x = product(ac_mass), fill=effectYes))

# Most collisions during the day #genauer betrachten
ggplot(birds) + 
  aes(x=time_of_day, fill=birds_struck) + 
  geom_bar()

```

check if clouds have an influence on effect 
hyptohesis: clouds lead to less vision therefore the pilot might not see the birds

```{r echo=FALSE, fig.asp=0.5}
prop.table(table(birds.filtered$sky,birds.filtered$effectYes),1)
ggplot(birds[!is.na(birds$effect) & !is.na(birds$sky),])+
  aes(x=sky, fill=effectYes)+
  geom_bar(position = "fill")
```

results show, that clouds do not have an impact on effect variable, 
the proportion of effect=true is a little higher for some clouds and overcast

check influence of birds seen on effect variable, we assume NA values as if no birds have been seen before the strike occured

```{r echo=FALSE, fig.asp=0.5}
#anteil der effect=true vergleichen when seen and not seen
#...
effectYes_seen <- ggplot(birds[!is.na(birds$effectYes),]) +
  aes(x=is.na(birds_seen), fill=effectYes) +
  geom_bar(position="fill")

#differences in kind of effect?
effect_seen <- ggplot(birds[!is.na(birds$effect) & birds$effect != "None" ,]) +
  aes(x=is.na(birds_seen), fill=effect) +
  geom_bar(position="fill")

effectYes_seen + effect_seen

```
proportion of effect is a little higher when birds were seen
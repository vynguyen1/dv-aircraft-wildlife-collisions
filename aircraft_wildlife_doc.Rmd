---
title: "Aircraft Wildlife collisions"
author: "Alexander Flick & Vy Nguyen"
date: "21/07/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data preparation

```{r echo=FALSE, message= FALSE, fig.asp=1}

library(openintro)
data("birds")
library(ggplot2)
library(patchwork)
library(ggmosaic)
library("viridis")
library(RColorBrewer) # https://www.datanovia.com/en/blog/top-r-color-palettes-to-know-for-great-data-visualization/  -> Purples, BuPu; Map: BrBG

theme_set(theme_minimal())
color_pal<-c("seagreen", "steelblue", "darkred", "orange")
color_pal_sky<-c("lightgoldenrod","honeydew","skyblue3")
color_pal_TF<-c("darksalmon","cadetblue")
theme.title<-theme(
    plot.title = element_text(
      hjust = 0.5, # center
      size = 12,
      color = "steelblue",
      face = "bold"
    ),
    plot.subtitle = element_text(
      hjust = 0.5, # center
      size = 10,
      color = "gray",
      face = "italic"
    )
  )

factor_phase_flt<-c("Parked", "Taxi", "Take-off run", "Climb", "En Route", "Descent", "Approach", "Landing Roll")
birds$phase_of_flt<-factor(birds$phase_of_flt, levels=factor_phase_flt)

factor_struck<-c("0", "1", "2-10", "11-100", "Over 100")
birds$birds_struck<-factor(birds$birds_struck, levels=factor_struck)

factor_sky<-c("No Cloud", "Some Cloud", "Overcast")
birds$sky <- factor(birds$sky, levels=factor_sky)

factor_effect <- c("None","Other","Aborted Take-off","Engine Shut Down","Precautionary Landing")
birds$effect <- factor(birds$effect, levels=factor_effect)

birds$effectYes<- as.factor(birds$effect != "None")

birds$num_engs <- as.factor(birds$num_engs)

#birds seen: remove one wrong entry
  # which(birds$birds_seen==":-10")
birds$birds_seen[9412] <- NA

factor_seen<-c("None","2-10", "11-100")
birds$birds_seen <- factor(birds$birds_seen, levels=factor_seen) 
  # drop unused level ":-10" by assigning levels again
birds$birds_seenYes <- as.factor(!is.na(birds$birds_seen))
#set Na values in birds seen to "None"
birds[is.na(birds$birds_seen),"birds_seen"] <- "None"
#\newpage
```

## Handling missing values

```{r echo=FALSE, message=FALSE, fig.asp=0.5}
#get rows where birds struck is missing
df <- birds[is.na(birds$birds_struck), 
            c("remarks", "birds_seen", "effect", "birds_struck")]
no_strike <- grepl("NOT A STRIKE|NO STRIKE|NOT A STRKE", df$remarks)
# set birds_struck to 0 for "no strike"
birds[is.na(birds$birds_struck),][no_strike,"birds_struck"] <- "0"

# Amount of na for each column
missing <- sapply(birds, function(x) sum(is.na(x)))
missing_df <- data.frame("column" = names(missing), 
                         "count" = missing, row.names = NULL)
names(missing_df)[2] <- "count"

ggplot(missing_df) + 
  aes(x=reorder(column, -count), y=count) +
  geom_bar(stat="identity", fill="snow3") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```

# Analysis of strikes (birds_struck)

```{r echo=FALSE, fig.asp=0.5}
birds_strike_phase <- ggplot(birds[!is.na(birds$phase_of_flt) & !is.na(birds$birds_struck),]) +
  aes(x = phase_of_flt, fill=birds_struck) +
  scale_fill_brewer(palette="Blues") +
  geom_bar()

#relationship of amount of birds struck with clouds?
birds_strike_sky <- ggplot(birds[!is.na(birds$sky) & !is.na(birds$birds_struck),])+
  aes(x=birds_struck, fill=sky)+
  scale_fill_manual(values = color_pal_sky)+
  geom_bar(position = "fill")

# Most collisions during the day #genauer betrachten
birds_strike_time <- ggplot(birds[!is.na(birds$time_of_day) & !is.na(birds$birds_struck),]) + 
  aes(x=time_of_day, fill=birds_struck) + 
  scale_fill_brewer(palette="Blues") +
  geom_bar()

### Birds struck out of birds seen
birds_struck_seen <- ggplot(birds[!is.na(birds$birds_seen) & !is.na(birds$birds_struck),]) +
  geom_mosaic(aes(x = product(birds_seen), fill=birds_struck)) +
  scale_fill_brewer(palette="Blues") +
  theme(axis.text.y=element_blank(), axis.ticks.y = element_blank())

(birds_strike_phase + birds_strike_sky) / (birds_strike_time + birds_struck_seen)
## descent and en-route are about equal 
```
TODO: add Chi-squared independence test for sky and birds struck
http://www.sthda.com/english/wiki/chi-square-test-of-independence-in-r



the higher the amount of birds struck the more clouds

## Closer look on En Rout and Descent
```{r echo=FALSE, fig.asp=0.5, warning=FALSE}
above_ground <- birds[as.integer(birds$phase_of_flt)>3 & as.integer(birds$phase_of_flt)<8 & !is.na(birds$phase_of_flt),]
height_by_phase <- ggplot(above_ground) +
  aes(x = phase_of_flt, y = height, fill=phase_of_flt) +
  stat_boxplot(geom="errorbar", width=0.4) +
  scale_fill_brewer(palette="Pastel2") +
  geom_boxplot()
# Heights during Descent are on average higher than 
# hypothesis: Collisions happen more often during Descent and are therefore more prominent in the data set?

#plot height density for Descent and EnRoute
density <- ggplot(birds[birds$phase_of_flt== "Descent" | birds$phase_of_flt=="En Route",]) +
  aes(x = height, group=phase_of_flt,fill=phase_of_flt ) +
  scale_fill_brewer(palette='Pastel2') +
  geom_density(adjust=1.5,alpha=.8)

height_by_phase + density

```

t.test
```{r echo=FALSE, fig.asp=1}
#Two sample t.test for height dependent on phase of flight ("Descent" and "En Route")
t.test(height~phase_of_flt, data = birds[as.integer(birds$phase_of_flt)>4 & as.integer(birds$phase_of_flt)<7 & !is.na(birds$phase_of_flt),])

```
For 0 birs struck we have highest percentage of no clouds, so clouds might have an affect on avoiding striking birds. Its about 20% higher compared to 1 bird struck.
for birdsstruck by sky we can see that with increasing amount of birds the sky tends to be more more overcast, as no clouds and some clouds decreases

## density birdsstuck by height
```{r echo=FALSE, warning=FALSE, fig.asp=0.5}
#could include only birds from vys categorization
#plot height density for Descent and EnRoute
density <- ggplot(above_ground[!is.na(above_ground$birds_struck),]) +
  aes(x = height, group=birds_struck,fill=birds_struck)+
  geom_density(adjust=1.5,alpha=.6) +
  scale_fill_brewer(palette="Blues") +
  xlim(0, 3500)
density

```

## Analysis of birds seen

there are only 2 levels in the data available for birds seen

```{r echo=FALSE, fig.asp=0.5}
#relationship of amount of birds seen with clouds?
birds_seen_plt <- ggplot(birds[!is.na(birds$time_of_day),])+
  aes(x=time_of_day, fill=birds_seen)+
  geom_bar(position = "fill") +
  scale_fill_brewer(palette="BuGn") +
  theme(legend.position="none")

birds_seenNo_sky <- ggplot(birds[!is.na(birds$sky),])+
  aes(x=sky, fill=birds_seen)+
  scale_fill_brewer(palette="BuGn") +
  geom_bar(position="fill")

#relationship of seen or not seen with daytime?
#table(is.na(birds$birds_seen), birds$time_of_day)

birds_seen_plt + birds_seenNo_sky
```
**Time of Day:** Based on the assumption that Missing values in the data for birds_seen stands for the fact that the pilot did not see wildlife before a strike happened, the proportion of birds seen before a strike happened is `r sum(birds$birds_seen!="None")/nrow(birds)`. The contingencytable looks like the following: `addmargins(prop.table(table(birds$birds_seen=="None", birds$time_of_day),2),2,FUN = mean)`. 

The proportion of overall birds seen at night is much lower compared to the other times (Dawn, Day, Dusk). And especially large wildlife groups (11-100) are even less likely seen at night compared to smaller groups (2-10).

**Sky:** the proportion of some clouds is nearly the same, but pilots do more often see bigger groups of birds (11-100) when its overcast compared to small groups
contradiction: would have expected to see less birds when amount of clouds increases. but especially the amount of birds in groups from 11-100 increases when the amount of clouds increases.

```{r echo=FALSE, fig.asp=0.5, figures-side, fig.show="hold"}
par(mfrow=c(1,2))
spineplot(birds$height, birds$birds_seen, col = rev(brewer.pal(n=3,name="BuGn")))
spineplot(birds$speed, birds$birds_seen, col = rev(brewer.pal(n=3,name="BuGn")))
```
The higher the speed & height, the less likely to see a bird before collision
for height > 2000 foot probability to see a birds before collision decreases 
for speed > 140 knots probability to see a bird before collision decreases

## effect when birdsstruck < birds seen

```{r echo=FALSE, fig.asp=0.5}
#Create new column
#calculate only when seen is not na
seen_vs_strike <- birds[birds$birds_seen!="None" & !is.na(birds$birds_struck),]
seen_vs_strike$birds_struck <- factor(seen_vs_strike$birds_struck)
seen_vs_strike$birds_seen <- factor(seen_vs_strike$birds_seen)
seen_vs_strike$less_strike_than_seen <- as.factor(as.integer(seen_vs_strike$birds_struck) < as.integer(seen_vs_strike$birds_seen)+2)

#TODO: Why is barplot different from ggplot???
#barplot(prop.table(table(seen_vs_strike$less_strike_than_seen,seen_vs_strike$effectYes),2), xlab = #"less_strike_than_seen")
#prop.table(table(seen_vs_strike$less_strike_than_seen,seen_vs_strike$effectYes),2)

# phase of flight by birdsstruck < birds seen
seen_vs_strike_phase <- ggplot(seen_vs_strike[!is.na(seen_vs_strike$phase_of_flt),]) +
  aes(x=phase_of_flt, fill=less_strike_than_seen) +
  scale_fill_manual(values = color_pal_TF)+
  geom_bar(position = "fill")

#ac_mass by leess-strike-than-seen (MOSAIC)
seen_vs_strike_ac_mass <- ggplot(seen_vs_strike[!is.na(seen_vs_strike$ac_mass),]) +
  geom_mosaic(aes(x=product(ac_mass), fill=less_strike_than_seen)) +
  scale_fill_manual(values = color_pal_TF)+
  theme(legend.position="none", axis.text.y=element_blank(), axis.ticks.y = element_blank())

#num_engs by leess-strike-than-seen (MOSAIC)
seen_vs_strike_num_engs <- ggplot(seen_vs_strike[!is.na(seen_vs_strike$num_engs),]) +
  geom_mosaic(aes(x=product(num_engs), fill=less_strike_than_seen)) +
  scale_fill_manual(values = color_pal_TF)+
  theme(legend.position="none", axis.text.y=element_blank(), axis.ticks.y = element_blank())

seen_vs_strike_phase / (seen_vs_strike_ac_mass + seen_vs_strike_num_engs)
```
the num of engines and ac mass have an influence of how much birds are striked out of the birds seen,
lighter machines and machines with less sngines tend to hit less wildlife out of the seen wildlife. This might be to better maneuvarability of the smaller aircrafts.

## Analysis of effect variable

```{r echo=FALSE, fig.asp=0.5}
#comparison right? because we actually want to compare here the positive impact
birds_struck_effect <- ggplot(birds[!is.na(birds$birds_struck) & !is.na(birds$effect),]) +
  aes(x = birds_struck, fill = effect) +
  scale_fill_brewer(palette="OrRd") +
  geom_bar(position="fill")

#mosaic in ggplot2
#https://xang1234.github.io/mosaicdiagrams/

#mosaic plot better than barplot visualizes also absolute differences
birds_effect_acmass <- ggplot(birds[!is.na(birds$ac_mass) & !is.na(birds$effect),]) +
  geom_mosaic(aes(x = product(ac_mass), fill=effect)) +
  scale_fill_brewer(palette="OrRd") +
  theme(legend.position="none", axis.text.y=element_blank(), axis.ticks.y = element_blank())

#birdds_seenYes by effect
birds_effect_seenYes <- ggplot(birds[!is.na(birds$effect),]) +
  geom_mosaic(aes(x = product(birds_seenYes), fill=effect))+
  scale_fill_brewer(palette="OrRd") +
  #theme(legend.title = element_blank())
  theme(legend.position="none", axis.text.y=element_blank(), axis.ticks.y = element_blank())

birds_struck_effect / (birds_effect_acmass + birds_effect_seenYes)

```
check influence of birds seen on effect variable, we assume NA values as if no birds have been seen before the strike occured

proportion of effect is a little higher when birds were seen => contradiction, we would expect to have less amount of effect when pilot is able to see birds before, cause he could 